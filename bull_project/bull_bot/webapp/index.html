<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hickmet Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –±–µ–∂–µ–≤–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --bg-primary: #FAF8F5;
            --bg-secondary: #F5F1EB;
            --bg-card: #FFFFFF;
            --accent-brown: #9B8474;
            --accent-dark: #6B5D52;
            --accent-light: #C4B5A7;
            --text-primary: #3D3935;
            --text-secondary: #8A827C;
            --border-color: #E8E3DC;
            --shadow-soft: 0 4px 12px rgba(107, 93, 82, 0.08);
            --shadow-medium: 0 8px 24px rgba(107, 93, 82, 0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-bottom: 60px;
            min-height: 100vh;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-dark);
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .app-header p {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .step.active {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border-color: var(--accent-dark);
            box-shadow: 0 4px 12px rgba(107, 93, 82, 0.3);
        }

        .step.completed {
            background: #E8F5E9;
            border-color: #2E7D32;
            color: #2E7D32;
        }
        
        label {
            display: block;
            margin-top: 18px;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-brown);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            background-color: var(--bg-card);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(107, 93, 82, 0.04);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-brown);
            background-color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(155, 132, 116, 0.15);
            transform: translateY(-1px);
        }
        
        .row {
            display: flex;
            gap: 12px;
        }
        
        .col {
            flex: 1;
        }
        
        /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏ */
        .city-buttons, .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .city-buttons input, .radio-group input {
            display: none;
        }
        
        .city-buttons label, .radio-group label {
            flex: 1;
            padding: 14px 20px;
            text-align: center;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
            box-shadow: var(--shadow-soft);
        }
        
        .city-buttons label:hover, .radio-group label:hover {
            border-color: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .city-buttons input:checked + label, .radio-group input:checked + label {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border-color: var(--accent-dark);
            box-shadow: 0 6px 16px rgba(107, 93, 82, 0.25);
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ */
        .tourist-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-soft);
            transition: all 0.3s ease;
        }
        
        .tourist-card:hover {
            box-shadow: var(--shadow-medium);
            border-color: var(--accent-light);
        }
        
        .tourist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .tourist-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-dark);
        }
        
        .passport-btn {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(107, 93, 82, 0.2);
        }
        
        .passport-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 93, 82, 0.3);
        }
        
        .passport-btn:active {
            transform: translateY(0);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .submit-btn {
            width: 100%;
            padding: 18px;
            margin-top: 24px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(107, 93, 82, 0.25);
            letter-spacing: 0.5px;
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 28px rgba(107, 93, 82, 0.35);
        }
        
        .submit-btn:active {
            transform: translateY(-1px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Smart box */
        .smart-box {
            background: linear-gradient(135deg, #FFFFFF 0%, var(--bg-secondary) 100%);
            padding: 20px;
            border-radius: 18px;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
        }
        
        .smart-box h3 {
            color: var(--accent-dark);
            margin-bottom: 16px;
            font-size: 20px;
            font-weight: 700;
        }
        
        /* –î–∞–Ω–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞ */
        .passport-data {
            background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
            padding: 14px;
            border-radius: 12px;
            margin-top: 12px;
            border: 2px solid #C8E6C9;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .phone-input {
            margin-top: 8px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .passport-data.visible {
            display: block;
        }
        
        .passport-field {
            font-size: 14px;
            margin: 6px 0;
            color: var(--text-primary);
            display: flex;
            padding: 6px 0;
            border-bottom: 1px solid rgba(139, 115, 85, 0.1);
        }
        
        .passport-field:last-child {
            border-bottom: none;
        }
        
        .passport-field strong {
            color: #2E7D32;
            min-width: 150px;
            font-weight: 600;
        }
        
        /* Details/Summary */
        details {
            margin-top: 20px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 14px;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-soft);
        }
        
        summary {
            font-weight: 700;
            padding: 14px;
            cursor: pointer;
            color: var(--accent-dark);
            font-size: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            list-style: none;
        }
        
        summary:hover {
            background: var(--bg-secondary);
        }
        
        summary::-webkit-details-marker {
            display: none;
        }
        
        summary::before {
            content: "üìÇ ";
            margin-right: 8px;
        }
        
        details[open] summary::before {
            content: "üìÇ ";
        }
        
        details > div {
            padding: 14px;
        }
        
        /* –ü–æ–∏—Å–∫ –¥–∞—Ç—ã */
        .date-search {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        .date-search input {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        }
        
        .search-btn {
            background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-dark) 100%);
            color: white;
            border-radius: 12px;
            padding: 0 24px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(107, 93, 82, 0.2);
            white-space: nowrap;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 93, 82, 0.3);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" */
        .back-btn {
            width: 100%;
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            margin-top: 12px;
            padding: 14px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            border-color: var(--accent-light);
            color: var(--accent-brown);
            background: var(--bg-secondary);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* –ò–∫–æ–Ω–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ */
        .icon {
            display: inline-block;
            margin-right: 6px;
        }
    </style>
</head>
<body>

<div class="app-header">
    <h1>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –£–º—Ä—ã</h1>
</div>

<div id="step_1">
    <div class="step-indicator">
        <div class="step active">1</div>
        <div class="step">2</div>
    </div>

    <div class="smart-box">
        <label><span class="icon"></span>1. –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞:</label>
        <div class="date-search">
            <input type="text" id="date_input" placeholder="13.12">
            <button type="button" onclick="handleSearch()" class="search-btn">–ù–∞–π—Ç–∏</button>
        </div>

        <label style="margin-top: 16px;"><span class="icon"></span>2. –ü–∞–∫–µ—Ç:</label>
        <select id="pkg_name" disabled>
            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É</option>
        </select>
    </div>

    <input type="hidden" id="sheet_name_hidden">
    <input type="hidden" id="table_id_hidden">

    <label><span class="icon">üõ´</span>–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞:</label>
    <div class="city-buttons">
        <input type="radio" name="departure_city" id="c_ala" value="Almaty" checked>
        <label for="c_ala">Almaty</label>
        <input type="radio" name="departure_city" id="c_ast" value="Astana">
        <label for="c_ast">Astana</label>
    </div>

    <label><span class="icon"></span>–ü–∞–ª–æ–º–Ω–∏–∫–∏:</label>
    <div id="pilgrims-container"></div>

    <div class="row">
        <div class="col">
            <label>AVIA –∑–∞–ø—Ä–æ—Å:</label>
            <input type="text" id="avia" placeholder="">
        </div>
        <div class="col">
            <label>VISA –¥–µ–π—Å—Ç–≤—É—é—â–∞—è:</label>
            <select id="visa_status">
                <option value="UMRAH VISA">NO VISA</option>
                <option value="TOUR VISA">TOUR VISA</option>
                <option value="NO VISA">UMRAH VISA</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>–¢–∏–ø –Ω–æ–º–µ—Ä–∞:</label>
            <select id="room_type">
                <option value="Double">Double</option>
                <option value="Triple">Triple</option>
                <option value="Quad">Quad</option>
                <option value="Single">Single</option>
            </select>
        </div>
        <div class="col">
            <label>–ü–∏—Ç–∞–Ω–∏–µ:</label>
            <select id="meal_type">
                <option value="HB">HB</option>
                <option value="BB">BB</option>
                <option value="FB">FB</option>
                <option value="INF">INF</option>
                <option value="CHD">CHD</option>
                <option value="RO">RO</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <label>–°—É–º–º–∞ –ø–∞–∫–µ—Ç–∞ ($):</label>
            <input type="tel" id="price" placeholder="">
        </div>
        <div class="col">
            <label>–û–ø–ª–∞—á–µ–Ω–æ ($):</label>
            <input type="tel" id="amount_paid" value="">
        </div>
    </div>

    <details>
        <summary>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</summary>
        <div>
            <label>–†–µ–≥–∏–æ–Ω:</label>
            <select id="region">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                <option value="Almaty">–ê–ª–º–∞—Ç—ã</option>
                <option value="Astana">–ê—Å—Ç–∞–Ω–∞</option>
                <option value="Shymkent">–®—ã–º–∫–µ–Ω—Ç</option>
                <option value="Atyrau">–ê—Ç—ã—Ä–∞—É</option>
                <option value="Aktobe">–ê–∫—Ç–æ–±–µ</option>
                <option value="Karaganda">–ö–∞—Ä–∞–≥–∞–Ω–¥–∞</option>
                <option value="Kostanay">–ö–æ—Å—Ç–∞–Ω–∞–π</option>
                <option value="Pavlodar">–ü–∞–≤–ª–æ–¥–∞—Ä</option>
                <option value="Turkistan">–¢—É—Ä–∫–µ—Å—Ç–∞–Ω</option>
                <option value="Mangystau">–ú–∞–Ω–≥–∏—Å—Ç–∞—É</option>
                <option value="EastKazakhstan">–í–ö–û</option>
                <option value="WestKazakhstan">–ó–ö–û</option>
                <option value="NorthKazakhstan">–°–ö–û</option>
                <option value="Kyzylorda">–ö—ã–∑—ã–ª–æ—Ä–¥–∞</option>
                <option value="Zhambyl">–ñ–∞–º–±—ã–ª</option>
                <option value="Abai">–ê–±–∞–π—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å</option>
                <option value="Ulytau">–£–ª—ã—Ç–∞—É</option>
                <option value="Jetisu">–ñ–µ—Ç—ã—Å—É</option>
                <option value="Other">–î—Ä—É–≥–æ–π</option>
            </select>

            <label>–î–æ–≥–æ–≤–æ—Ä ‚Ññ:</label>
            <input type="text" id="contract_number" value="">

            <label>–ö—É—Ä—Å $:</label>
            <input type="tel" id="exchange_rate" placeholder="">

            <label>–°–∫–∏–¥–∫–∞:</label>
            <input type="text" id="discount" value="">

            <label>–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
            <input type="text" id="source" placeholder="">

            <label>–ü–æ–µ–∑–¥:</label>
            <select id="train">
                <option value="-">–ù–µ—Ç</option>
                <option value="YES">–î–∞</option>
            </select>
        </div>
    </details>

    <label>–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
    <input type="text" id="manager_name_text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞...">
    
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
    <textarea id="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>

    <button class="submit-btn" onclick="goToStep2()">
        <span class="icon">‚û°Ô∏è</span> –î–ê–õ–ï–ï –ö –†–ê–ó–ú–ï–©–ï–ù–ò–Æ
    </button>
</div>

<div id="step_2" style="display: none;">
    <div class="step-indicator">
        <div class="step completed">‚úì</div>
        <div class="step active">2</div>
    </div>

    <div class="smart-box">
        <h3>–†–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>

        <div id="group_logic" style="display: none; margin-bottom: 20px;">
            <label>–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:</label>
            <div class="city-buttons">
                <input type="radio" name="placement_type" id="m_fam" value="family">
                <label for="m_fam">üë™ –°–µ–º—å—è (–≤–º–µ—Å—Ç–µ)</label>
                <input type="radio" name="placement_type" id="m_sep" value="separate" checked>
                <label for="m_sep">üöª –†–∞–∑–¥–µ–ª—å–Ω–æ (–ø–æ –ø–æ–ª—É)</label>
            </div>
        </div>

        <label>–ú–µ—Ç–æ–¥ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É:</label>
        <div class="radio-group" style="flex-direction: column;">
            <input type="radio" name="place_method" id="meth_auto" value="auto" checked onchange="updateUI()">
            <label for="meth_auto">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–≤–æ–±–æ–¥–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ)</label>

            <input type="radio" name="place_method" id="meth_pick" value="pick" onchange="updateUI()">
            <label for="meth_pick">–ü–æ–¥—Å–µ–ª–∏—Ç—å (–í—ã–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É)</label>

        </div>

        <div id="room_list_div" style="display: none; margin-top: 20px;">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ:</label>
            <select id="room_select"></select>
        </div>

        <div id="manual_div" style="display: none; margin-top: 20px;">
            <label>–ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–Ω–∞–ø—Ä. 145):</label>
            <input type="number" id="manual_row_input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏">
        </div>
    </div>

    <button class="submit-btn" id="finish_btn" onclick="finalSubmit()">
        <span class="icon">‚úÖ</span> –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨
    </button>
    <button onclick="backToStep1()" class="back-btn">
        <span class="icon">‚¨ÖÔ∏è</span> –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º
    </button>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const API_URL = window.BULL_API_URL;
    let pilgrimsData = [];
    let uploadedPassports = {}; // idx -> path

    // --- –ü–û–ò–°–ö –ü–ê–ö–ï–¢–û–í ---
    async function handleSearch() {
        let date = document.getElementById('date_input').value.trim().replace(/[\/\s,]/g, '.');
        document.getElementById('date_input').value = date;

        if (date.length < 5) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –ø–æ–ª–Ω–æ—Å—Ç—å—é (–Ω–∞–ø—Ä. 13.12)");

        const sel = document.getElementById('pkg_name');
        sel.innerHTML = '<option class="loading">‚è≥ –ü–æ–∏—Å–∫ –ø–∞–∫–µ—Ç–æ–≤...</option>';

        try {
            const r = await fetch(`${API_URL}/api/packages?date=${date}`, { headers: {"ngrok-skip-browser-warning":"1"} });
            const res = await r.json();

            if (res.found) {
                sel.disabled = false;
                sel.innerHTML = res.data.map(i => `<option value="${i.n}" data-sheet="${i.s}" data-table="${i.t}">${i.n}</option>`).join('');
                document.getElementById('sheet_name_hidden').value = res.data[0].s;
                document.getElementById('table_id_hidden').value = res.data[0].t;
            } else {
                sel.innerHTML = '<option>‚ùå –ù–µ—Ç —Ä–µ–π—Å–æ–≤</option>';
                sel.disabled = true;
            }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
    }

    document.getElementById('date_input').addEventListener('input', function() {
        if (this.value.length === 5) handleSearch();
    });

    document.getElementById('pkg_name').onchange = (e) => {
        const opt = e.target.options[e.target.selectedIndex];
        document.getElementById('sheet_name_hidden').value = opt.dataset.sheet;
        document.getElementById('table_id_hidden').value = opt.dataset.table;
    };

    async function uploadPassport(file) {
        const formData = new FormData();
        formData.append("file", file);

        const res = await fetch(`${API_URL}/api/passports/upload`, {
            method: "POST",
            body: formData,
            headers: {"ngrok-skip-browser-warning":"1"}
        });
        const json = await res.json();
        if (!res.ok || !json.ok) {
            throw (json.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ${res.status}`);
        }
        return json.path;
    }

    // --- –ü–ê–†–°–ò–ù–ì –¢–£–†–ò–°–¢–û–í –ò–ó URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const pRaw = urlParams.get('pilgrims');
    const modeParam = urlParams.get('mode');
    const editBookingId = urlParams.get('booking_id');
    const oldBookingId = urlParams.get('old_booking_id');

    console.log("üì• URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:");
    console.log("   pilgrims:", pRaw ? "–µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ" : "–Ω–µ—Ç");
    console.log("   mode:", modeParam);
    console.log("   booking_id:", editBookingId);
    console.log("   old_booking_id:", oldBookingId);

    let currentMode = modeParam || localStorage.getItem('mode') || 'create';
    let currentBookingId = editBookingId || localStorage.getItem('edit_booking_id') || null;
    let currentOldBookingId = oldBookingId || localStorage.getItem('old_booking_id') || null;

    // –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ URL (–±–æ—Ç)
    if (pRaw) {
        try {
            const pilgrims = JSON.parse(decodeURIComponent(pRaw));
            console.log("‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", pilgrims);

            pilgrimsData = pilgrims.map(p => ({
                name: p.name || `${p.last_name || '-'} ${p.first_name || '-'}`,
                last_name: p.last_name || "-",
                first_name: p.first_name || "-",
                phone: p.phone || "-",
                passport_num: p.passport_num || "-",
                date_of_birth: p.date_of_birth || "-",
                gender: p.gender || "M",
                passport_expiry: p.passport_expiry || "-",
                iin: p.iin || "-",
                passport_image_path: p.passport_image_path || null
            }));

            console.log("üìã –§–∏–Ω–∞–ª—å–Ω—ã–π pilgrimsData:", pilgrimsData);
            renderPilgrims();
        } catch(e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:", e);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Å–ø–æ—Ä—Ç–æ–≤");
        }
    } else {
        // –§–æ–ª–±–µ–∫ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏: —á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
        const isReschedule = localStorage.getItem('is_reschedule') === 'true';
        const rescheduleDataRaw = localStorage.getItem('reschedule_data');
        const isEdit = localStorage.getItem('is_edit') === 'true';
        const editDataRaw = localStorage.getItem('edit_data');

        if (isReschedule && rescheduleDataRaw) {
            try {
                const p = JSON.parse(rescheduleDataRaw);
                pilgrimsData = [{
                    name: `${p.last_name || '-'} ${p.first_name || '-'}`,
                    last_name: p.last_name || "-",
                    first_name: p.first_name || "-",
                    phone: p.phone || "-",
                    passport_num: p.passport_num || "-",
                    date_of_birth: p.date_of_birth || "-",
                    gender: p.gender || "M",
                    passport_expiry: p.passport_expiry || "-",
                    iin: p.iin || "-",
                    passport_image_path: p.passport_image_path || null
                }];
                console.log("‚ôªÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–∑ localStorage:", pilgrimsData);
                renderPilgrims();
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞:", e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–∞");
            } finally {
                localStorage.removeItem('is_reschedule');
                localStorage.removeItem('reschedule_data');
                localStorage.removeItem('reschedule_booking_id');
            }
        } else if (isEdit && editDataRaw) {
            try {
                const p = JSON.parse(editDataRaw);
                currentMode = 'edit';
                currentBookingId = localStorage.getItem('edit_booking_id') || null;
                pilgrimsData = [{
                    name: `${p.last_name || '-'} ${p.first_name || '-'}`,
                    last_name: p.last_name || "-",
                    first_name: p.first_name || "-",
                    phone: p.phone || "-",
                    passport_num: p.passport_num || "-",
                    date_of_birth: p.date_of_birth || "-",
                    gender: p.gender || "M",
                    passport_expiry: p.passport_expiry || "-",
                    iin: p.iin || "-",
                    passport_image_path: p.passport_image_path || null
                }];
                console.log("‚úèÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ localStorage:", pilgrimsData);
                renderPilgrims();
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
            } finally {
                // –ù–µ —á–∏—Å—Ç–∏–º edit-—Ñ–ª–∞–≥–∏ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
            }
        }
    }

    // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ –∏–∑ API
    if (currentMode === 'edit' && currentBookingId) {
        console.log("üìã –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –∑–∞–≥—Ä—É–∂–∞—é –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ #" + currentBookingId);
        loadBookingData(currentBookingId);
    }

    function renderPilgrims() {
        const container = document.getElementById('pilgrims-container');
        container.innerHTML = pilgrimsData.map((p, idx) => `
            <div class="tourist-card">
                <div class="tourist-header">
                    <span class="tourist-name">üë§ ${p.name}</span>
                    <button onclick="togglePassportData(${idx})" class="passport-btn">
                        üìã –ü–∞—Å–ø–æ—Ä—Ç
                    </button>
                </div>
                <input type="tel" class="phone-input" data-idx="${idx}" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" value="${p.phone !== '-' ? p.phone : ''}">
                <div class="upload-wrapper">
                    <label>–§–æ—Ç–æ –ø–∞—Å–ø–æ—Ä—Ç–∞ (jpg/png/pdf):</label>
                    <input type="file" accept=".jpg,.jpeg,.png,.pdf" data-idx="${idx}" class="passport-file">
                    ${p.passport_image_path ? `<div class="file-info">–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: ${p.passport_image_path}</div>` : ''}
                </div>

                <div id="passport_${idx}" class="passport-data">
                    <div class="passport-field"><strong>–§–∞–º–∏–ª–∏—è:</strong> <span>${p.last_name}</span></div>
                    <div class="passport-field"><strong>–ò–º—è:</strong> <span>${p.first_name}</span></div>
                    <div class="passport-field"><strong>–ü–æ–ª:</strong> <span>${p.gender === 'M' ? 'üë® –ú—É–∂—Å–∫–æ–π' : 'üë© –ñ–µ–Ω—Å–∫–∏–π'}</span></div>
                    <div class="passport-field"><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <span>${p.date_of_birth}</span></div>
                    <div class="passport-field"><strong>–ü–∞—Å–ø–æ—Ä—Ç:</strong> <span>${p.passport_num}</span></div>
                    <div class="passport-field"><strong>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</strong> <span>${p.passport_expiry}</span></div>
                    <div class="passport-field"><strong>–ò–ò–ù:</strong> <span>${p.iin}</span></div>
                </div>
            </div>
        `).join('');

        document.querySelectorAll('.phone-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const idx = e.target.dataset.idx;
                pilgrimsData[idx].phone = e.target.value;
            });
        });
        document.querySelectorAll('.passport-file').forEach(input => {
            input.addEventListener('change', async (e) => {
                const idx = e.target.dataset.idx;
                const file = e.target.files[0];
                if (!file) return;

                try {
                    e.target.disabled = true;
                    e.target.insertAdjacentHTML('afterend', '<div class="file-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>');
                    const path = await uploadPassport(file);
                    pilgrimsData[idx].passport_image_path = path;
                    renderPilgrims(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                } catch (err) {
                    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: " + err);
                    e.target.value = "";
                }
            });
        });
    }

    function togglePassportData(idx) {
        const el = document.getElementById(`passport_${idx}`);
        el.classList.toggle('visible');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    async function loadBookingData(bookingId) {
        try {
            console.log("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏ #" + bookingId);
            const res = await fetch(`${API_URL}/api/bookings/${bookingId}`, {
                headers: {"ngrok-skip-browser-warning": "1"}
            });
            const json = await res.json();

            if (!res.ok || !json.ok) {
                throw new Error(json.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏");
            }

            const booking = json.booking;
            console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ –ø–æ–ª—É—á–µ–Ω—ã:", booking);

            // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            if (booking.package_name) {
                const pkgSelect = document.getElementById('pkg_name');
                pkgSelect.innerHTML = `<option value="${booking.package_name}">${booking.package_name}</option>`;
                pkgSelect.value = booking.package_name;
                pkgSelect.disabled = false;
            }

            if (booking.sheet_name) {
                document.getElementById('sheet_name_hidden').value = booking.sheet_name;
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "JUNE 15.06")
                const dateMatch = booking.sheet_name.match(/(\d{1,2})\.(\d{1,2})/);
                if (dateMatch) {
                    document.getElementById('date_input').value = `${dateMatch[1]}.${dateMatch[2]}`;
                }
            }

            if (booking.price) {
                document.getElementById('price').value = booking.price;
            }

            if (booking.room_type) {
                document.getElementById('room_type').value = booking.room_type;
            }

            if (booking.meal_type) {
                document.getElementById('meal_type').value = booking.meal_type;
            }

            if (booking.manager_name) {
                document.getElementById('manager_name_text').value = booking.manager_name;
            }

            if (booking.comment) {
                document.getElementById('comment').value = booking.comment;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å table_id, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
            if (booking.table_id) {
                const tableIdInput = document.getElementById('table_id_hidden');
                if (tableIdInput) {
                    tableIdInput.value = booking.table_id;
                }
            }

            console.log("‚úÖ –í—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω—ã");
            return booking;
        } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏:", e);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–∏: " + e.message);
            return null;
        }
    }

    // –ü–æ–ª–µ "–ú–µ–Ω–µ–¥–∂–µ—Ä" —Ç–µ–ø–µ—Ä—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
    // if (tg.initDataUnsafe?.user) {
    //     document.getElementById('manager_name_text').value = tg.initDataUnsafe.user.first_name;
    // }

    function goToStep2() {
        const pkg = document.getElementById('pkg_name').value;
        const price = document.getElementById('price').value;
        if (!pkg || pkg === "" || !price) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ü–∞–∫–µ—Ç –∏ –¶–µ–Ω—É!");

        document.getElementById('step_1').style.display = 'none';
        document.getElementById('step_2').style.display = 'block';
        window.scrollTo(0, 0);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ü–∏–∏ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è, –µ—Å–ª–∏ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ –±–æ–ª—å—à–µ 1
        if (pilgrimsData.length > 1) {
            document.getElementById('group_logic').style.display = 'block';
        }

        fetchAvailableRooms();
    }

    function backToStep1() {
        document.getElementById('step_2').style.display = 'none';
        document.getElementById('step_1').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function updateUI() {
        const m = document.querySelector('input[name="place_method"]:checked').value;
        document.getElementById('room_list_div').style.display = m === 'pick' ? 'block' : 'none';
        document.getElementById('manual_div').style.display = m === 'manual' ? 'block' : 'none';
    }

    async function fetchAvailableRooms() {
        const sel = document.getElementById('room_select');
        sel.innerHTML = '<option class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç...</option>';

        const params = new URLSearchParams({
            table_id: document.getElementById('table_id_hidden').value,
            sheet_name: document.getElementById('sheet_name_hidden').value,
            package_name: document.getElementById('pkg_name').value,
            count: pilgrimsData.length,
            room_type: document.getElementById('room_type').value,
            gender: pilgrimsData[0]?.gender || 'M'
        });

        try {
            const r = await fetch(`${API_URL}/api/rooms?${params}`, { headers: {"ngrok-skip-browser-warning":"1"} });
            const res = await r.json();
            if (res.found && res.rooms.length > 0) {
                sel.innerHTML = res.rooms.map(rm => {
                    const icon = rm.gender === 'F' ? 'üö∫' : 'üöπ';
                    const label = rm.label || `${rm.type} ¬∑ ${rm.last_guest || '–°–≤–æ–±–æ–¥–Ω–æ'} (–°–≤–æ–±–æ–¥–Ω–æ: ${rm.free})`;
                    return `<option value="${rm.row}">${icon} ${label} [–°—Ç—Ä–æ–∫–∞: ${rm.row}]</option>`;
                }).join('');
            } else {
                sel.innerHTML = '<option value="">–ù–µ—Ç –º–µ—Å—Ç –¥–ª—è –ø–æ–¥—Å–µ–ª–µ–Ω–∏—è</option>';
            }
        } catch(e) { sel.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>'; }
    }

    async function finalSubmit() {
        const method = document.querySelector('input[name="place_method"]:checked').value;
        let row = null;
        if (method === 'pick') row = document.getElementById('room_select').value;
        if (method === 'manual') row = document.getElementById('manual_row_input').value;

        const pilgrims = pilgrimsData.map(p => ({
            first_name: p.first_name,
            last_name: p.last_name,
            phone: p.phone,
            passport_num: p.passport_num,
            date_of_birth: p.date_of_birth,
            gender: p.gender,
            passport_expiry: p.passport_expiry,
            iin: p.iin,
            passport_image_path: p.passport_image_path || null
        }));

        console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", pilgrims);

        const visaValue = document.getElementById('visa_status').value;
        const normalizedVisa = visaValue === 'NO VISA' ? '-' : visaValue;

        const data = {
            pilgrims: pilgrims,
            package_name: document.getElementById('pkg_name').value,
            sheet_name: document.getElementById('sheet_name_hidden').value,
            table_id: document.getElementById('table_id_hidden').value,
            departure_city: document.querySelector('input[name="departure_city"]:checked').value,
            room_type: document.getElementById('room_type').value,
            meal_type: document.getElementById('meal_type').value,
            visa_status: normalizedVisa,
            avia: document.getElementById('avia').value,
            price: document.getElementById('price').value,
            amount_paid: document.getElementById('amount_paid').value,
            contract_number: document.getElementById('contract_number').value,
            exchange_rate: document.getElementById('exchange_rate').value,
            discount: document.getElementById('discount').value,
            source: document.getElementById('source').value,
            region: document.getElementById('region').value,
            train: document.getElementById('train').value,
            manager_name_text: document.getElementById('manager_name_text').value,
            comment: document.getElementById('comment').value,
            placement_type: document.querySelector('input[name="placement_type"]:checked')?.value || 'separate',
            specific_row: row ? parseInt(row) : null,
            manager_id: tg.initDataUnsafe?.user?.id || 0
        };

        console.log("üì§ –†–µ–∂–∏–º –æ—Ç–ø—Ä–∞–≤–∫–∏:", currentMode);
        console.log("   booking_id:", currentBookingId);
        console.log("   old_booking_id:", currentOldBookingId);

        try {
            const btn = document.getElementById('finish_btn');
            btn.disabled = true;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º endpoint –∏ –º–µ—Ç–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let endpoint, method, btnText;

            if (currentMode === 'edit' && currentBookingId) {
                // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±—Ä–æ–Ω—å
                endpoint = `${API_URL}/api/bookings/${currentBookingId}`;
                method = "PATCH";
                btnText = '<span class="icon">‚è≥</span> –°–æ—Ö—Ä–∞–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è...';
                console.log("‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –±—Ä–æ–Ω–∏ #" + currentBookingId);
            } else {
                // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±—Ä–æ–Ω—å
                endpoint = `${API_URL}/api/bookings/submit`;
                method = "POST";
                btnText = '<span class="icon">‚è≥</span> –ó–∞–ø–∏—Å—ã–≤–∞—é...';

                if (currentMode === 'reschedule' && currentOldBookingId) {
                    console.log("‚ôªÔ∏è –ü–ï–†–ï–ù–û–° –±—Ä–æ–Ω–∏ (—Å—Ç–∞—Ä–∞—è #" + currentOldBookingId + ")");
                } else {
                    console.log("‚ûï –°–û–ó–î–ê–ù–ò–ï –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏");
                }
            }

            btn.innerHTML = btnText;

            const res = await fetch(endpoint, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "1"
                },
                body: JSON.stringify(data)
            });

            const json = await res.json().catch(() => ({}));

            if (!res.ok || !json.ok) {
                const msg = json.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`;
                alert("‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: " + msg);
                btn.disabled = false;
                btn.innerHTML = '<span class="icon">‚úÖ</span> –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let successMessage;
            if (currentMode === 'edit') {
                successMessage = "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!";
            } else if (currentMode === 'reschedule') {
                successMessage = "‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!";
            } else {
                successMessage = "‚úÖ –ë—Ä–æ–Ω—å —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–∞!";
            }
            alert(successMessage);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Telegram –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            tg.sendData(JSON.stringify({
                action: "booking_completed",
                mode: currentMode,
                saved_rows: json.saved_rows || []
            }));

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
            tg.close();
        } catch (e) {
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e);
            const btn = document.getElementById('finish_btn');
            btn.disabled = false;
            btn.innerHTML = '<span class="icon">‚úÖ</span> –ó–ê–í–ï–†–®–ò–¢–¨ –ò –ó–ê–ü–ò–°–ê–¢–¨';
        }
    }
</script>
</body>
</html>
